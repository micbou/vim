version: "{build}"
skip_non_tags: true
environment:
    vim_compilation_credit: micbou <contact@micbou.com>
    bintray_username: micbou
    bintray_api_key:
        secure: B1GlaWpEZ4f1oU6Hfi0XKe/LUoqJgJVUtXP8QxENtezlyNDqvRMfw1gX7btpEYk9
    matrix:
        #- arch: 32
        #  msvc: 11
        - arch: 32
          msvc: 12
        #- arch: 32
        #  msvc: 14
        #- arch: 64
        #  msvc: 11
        - arch: 64
          msvc: 12
        #- arch: 64
        #  msvc: 14
matrix:
    allow_failures:
        - msvc: 14
install:
    # Install NSIS and update PATH
    - curl -fsSL -o nsis-3.0b2-setup.exe http://prdownloads.sourceforge.net/nsis/nsis-3.0b2-setup.exe
    - nsis-3.0b2-setup.exe /S
    - set PATH=C:\Program Files (x86)\NSIS;%PATH%
    # Install UPX
    - curl -fsSL -o upx391w.zip http://upx.sourceforge.net/download/upx391w.zip
    - 7z x upx391w.zip
    - set PATH=%APPVEYOR_BUILD_FOLDER%\upx391w;%PATH%
    # Requirement for bintray script
    - ps: (new-object net.webclient).DownloadFile('https://raw.github.com/pypa/pip/master/contrib/get-pip.py', 'C:\get-pip.py')
    - python C:\get-pip.py
    - set PATH=C:\Python27\Scripts;%PATH%
    - pip install requests
build_script:
    - python appveyor\build.py --msvc %msvc% --arch %arch% --credit "%vim_compilation_credit%"
    - appveyor\artifact.bat %arch% %appveyor_repo_tag_name%
    - python appveyor\deploy.py %artifact%
    - set vim_description=Vim %version% 32-bit and 64-bit for Windows with python 2.7 and python 3.4 support. Compiled with MSVC %msvc%.
test_script:
    - python appveyor\test.py --msvc %msvc%
artifacts:
    - path: nsis\$(artifact)
      name: vim
deploy:
    - release: $(appveyor_repo_tag_name)
      description: $(vim_description)
      provider: GitHub
      auth_token:
          secure: gm7NWc/q5jrfYIipgRGs8Xd8+4BmWeEAEgfnCJYcu2EpgFdAxIMcT6ixBCE2gg5F
      artifact: vim
      draft: false
      prerelease: false
      on:
          branch: master
          appveyor_repo_tag: true
          msvc: 12
# Deploy to Bintray
after_deploy:
    - python appveyor\bintray.py upload generic vim %appveyor_repo_tag_name% nsis\%artifact% --override
    - python appveyor\bintray.py update-version generic vim %appveyor_repo_tag_name% "%vim_description%" --vcs-tag %appveyor_repo_tag_name%
    - python appveyor\bintray.py publish generic vim %appveyor_repo_tag_name%
    - python appveyor\bintray.py download-list generic %artifact% add
